<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2014-2015 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Custom Dataset Exploration &mdash; Cask Data Application Platform 2.7.1 Documentation</title>
    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.7.1 Documentation" href="../index.html" />
    <link rel="up" title="Data Exploration" href="index.html" />
    <link rel="next" title="Advanced Topics" href="../advanced/index.html" />
    <link rel="prev" title="Fileset Exploration" href="filesets.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../advanced/index.html" title="Advanced Topics"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="filesets.html" title="Fileset Exploration"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('2.7.1');</script>
       
        <li><a href="../table-of-contents.html">CDAP Developers’ Manual</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Data Exploration</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="custom-dataset-exploration">
<span id="id1"></span><h1>Custom Dataset Exploration<a class="headerlink" href="#custom-dataset-exploration" title="Permalink to this headline">¶</a></h1>
<p>It is often useful to be able to explore a Dataset in an ad-hoc manner.
This can be done using SQL if your Dataset fulfills two requirements:</p>
<ul class="simple">
<li>it defines the schema for each record; and</li>
<li>it has a method to scan its data record by record.</li>
</ul>
<p>For CDAP Datasets, this is done by implementing the <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> interface.
The CDAP built-in Dataset <tt class="docutils literal"><span class="pre">KeyValueTable</span></tt> already implements this and can be used for ad-hoc queries.</p>
<p>Let&#8217;s take a closer look at the <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> interface.</p>
<div class="section" id="defining-the-record-schema">
<h2>Defining the Record Schema<a class="headerlink" href="#defining-the-record-schema" title="Permalink to this headline">¶</a></h2>
<p>The record schema is given by returning the Java type of each record, and CDAP will derive the record schema from
that type:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">();</span>
</pre></div>
</div>
<p>For example, suppose you have a class <tt class="docutils literal"><span class="pre">Entry</span></tt> defined as:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>You can implement a record-scannable Dataset that uses <tt class="docutils literal"><span class="pre">Entry</span></tt> as the record type:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">MyDataset</span> <span class="o">...</span> <span class="kd">implements</span> <span class="n">RecordScannable</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Entry</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
  <span class="o">}</span>
</pre></div>
</div>
<p>Note that Java&#8217;s <tt class="docutils literal"><span class="pre">Class</span></tt> implements <tt class="docutils literal"><span class="pre">Type</span></tt> and you can simply return <tt class="docutils literal"><span class="pre">Entry.class</span></tt> as the record type.
CDAP will use reflection to infer a SQL-style schema using the fields of the record type.</p>
<p>In the case of the above class <tt class="docutils literal"><span class="pre">Entry</span></tt>, the schema will be:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">(</span><span class="n">key</span> <span class="n">STRING</span><span class="o">,</span> <span class="n">value</span> <span class="n">INT</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="limitations">
<span id="sql-limitations"></span><h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">The record type must be a structured type, that is, a Java class with fields. This is because SQL tables require
a structure type at the top level. This means the record type cannot be a primitive,
collection or map type. However, these types may appear nested inside the record type.</p>
</li>
<li><p class="first">The record type must be that of an actual Java class, not an interface. The same applies to the types of any
fields contained in the type. The reason is that interfaces only define methods but not fields; hence, reflection
would not be able to derive any fields or types from the interface.</p>
<p>The one exception to this rule is that Java collections such as <tt class="docutils literal"><span class="pre">List</span></tt> and <tt class="docutils literal"><span class="pre">Set</span></tt> are supported as well as
Java <tt class="docutils literal"><span class="pre">Map</span></tt>. This is possible because these interfaces are so commonly used that they deserve special handling.
These interfaces are parameterized and require special care as described in the next section.</p>
</li>
<li><p class="first">The record type must not be recursive. In other words, it cannot contain any class that directly or indirectly
contains a member of that same class. This is because a recursive type cannot be represented as a SQL schema.</p>
</li>
<li><p class="first">Fields of a class that are declared static or transient are ignored during schema generation. This means that the
record type must have at least one non-transient and non-static field. For example,
the <tt class="docutils literal"><span class="pre">java.util.Date</span></tt> class has only static and transient fields. Therefore a record type of <tt class="docutils literal"><span class="pre">Date</span></tt> is not
supported and will result in an exception when the Dataset is created.</p>
</li>
<li><p class="first">A Dataset can only be used in ad-hoc queries if its record type is completely contained in the Dataset definition.
This means that if the record type is or contains a parameterized type, then the type parameters must be present in
the Dataset definition. The reason is that the record type must be instantiated when executing an ad-hoc query.
If a type parameter depends on the jar file of the application that created the Dataset, then this jar file is not
available to the query execution runtime.</p>
<p>For example, you cannot execute ad-hoc queries over an <tt class="docutils literal"><span class="pre">ObjectStore&lt;MyObject&gt;</span></tt> if the <tt class="docutils literal"><span class="pre">MyObject</span></tt> is contained in
the application jar. However, if you define your own Dataset type <tt class="docutils literal"><span class="pre">MyObjectStore</span></tt> that extends or encapsulates an
<tt class="docutils literal"><span class="pre">ObjectStore&lt;MyObject&gt;</span></tt>, then <tt class="docutils literal"><span class="pre">MyObject</span></tt> becomes part of the Dataset definition for <tt class="docutils literal"><span class="pre">MyObjectStore</span></tt>. See the
<a class="reference external" href="../source/../../examples-manual/examples/purchase.html#examples-purchase" title="(in Cask Data Application Platform v2.7.1)"><em class="xref std std-ref">Purchase</em></a> application for an example.</p>
</li>
</ul>
</div>
<div class="section" id="parameterized-types">
<h2>Parameterized Types<a class="headerlink" href="#parameterized-types" title="Permalink to this headline">¶</a></h2>
<p>Suppose instead of being fixed to <tt class="docutils literal"><span class="pre">String</span></tt> and <tt class="docutils literal"><span class="pre">int</span></tt>, the <tt class="docutils literal"><span class="pre">Entry</span></tt> class is generic with type parameters for both
key and value:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">GenericEntry</span><span class="o">&lt;</span><span class="n">KEY</span><span class="o">,</span> <span class="n">VALUE</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">KEY</span> <span class="n">key</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">VALUE</span> <span class="n">value</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>We should easily be able to implement <tt class="docutils literal"><span class="pre">RecordScannable&lt;GenericEntry&lt;String,</span> <span class="pre">Integer&gt;&gt;</span></tt> by defining <tt class="docutils literal"><span class="pre">getRecordType()</span></tt>.
However, due to Java&#8217;s runtime type erasure, returning <tt class="docutils literal"><span class="pre">GenericEntry.class</span></tt> does not convey complete information
about the record type. With reflection, CDAP can only determine the names of the two fields, but not their types.</p>
<p>To convey information about the type parameters, we must instead return a <tt class="docutils literal"><span class="pre">ParameterizedType</span></tt>, which Java&#8217;s
<tt class="docutils literal"><span class="pre">Class</span></tt> does not implement. An easy way is to use Guava&#8217;s <tt class="docutils literal"><span class="pre">TypeToken</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">MyDataset</span> <span class="o">...</span> <span class="kd">implements</span> <span class="n">RecordScannable</span><span class="o">&lt;</span><span class="n">GenericEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span>
  <span class="kd">public</span> <span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TypeToken</span><span class="o">&lt;</span><span class="n">GenericEntry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{</span> <span class="o">}.</span><span class="na">getType</span><span class="o">();</span>
  <span class="o">}</span>
</pre></div>
</div>
<p>While this seems a little more complex at first sight, it is the de-facto standard way of dealing with Java type
erasure.</p>
</div>
<div class="section" id="complex-types">
<h2>Complex Types<a class="headerlink" href="#complex-types" title="Permalink to this headline">¶</a></h2>
<p>Your record type can also contain nested structures, lists, or maps, and they will be mapped to type names as defined in
the <a class="reference external" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL">Hive language manual</a>. For example, if
your record type is defined as:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">Movie</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">year</span><span class="o">;</span>
  <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">cast</span><span class="o">;</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">reviews</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The SQL schema of the dataset would be:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="o">(</span><span class="n">title</span> <span class="n">STRING</span><span class="o">,</span> <span class="n">year</span> <span class="n">INT</span><span class="o">,</span> <span class="n">cast</span> <span class="n">MAP</span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">,</span> <span class="n">STRING</span><span class="o">&gt;,</span> <span class="n">reviews</span> <span class="n">ARRAY</span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;)</span>
</pre></div>
</div>
<p>Refer to the Hive language manual for more details on schema and data types.</p>
</div>
<div class="section" id="scanning-records">
<span id="sql-scanning-records"></span><h2>Scanning Records<a class="headerlink" href="#scanning-records" title="Permalink to this headline">¶</a></h2>
<p>The second requirement for enabling SQL queries over a Dataset is to provide a means of scanning the Dataset record
by record. Similar to how the <tt class="docutils literal"><span class="pre">BatchReadable</span></tt> interface makes Datasets readable by Map/Reduce jobs by iterating
over pairs of key and value, <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> iterates over records. You need to implement a method to partition the
Dataset into splits, and an additional method to create a record scanner for each split:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">Split</span><span class="o">&gt;</span> <span class="nf">getSplits</span><span class="o">();</span>
<span class="n">RecordScanner</span><span class="o">&lt;</span><span class="n">RECORD</span><span class="o">&gt;</span> <span class="nf">createSplitRecordScanner</span><span class="o">(</span><span class="n">Split</span> <span class="n">split</span><span class="o">);</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">RecordScanner</span></tt> is very similar to a <tt class="docutils literal"><span class="pre">SplitReader</span></tt>; except that instead of <tt class="docutils literal"><span class="pre">nextKeyValue()</span></tt>,
<tt class="docutils literal"><span class="pre">getCurrentKey()</span></tt>, and <tt class="docutils literal"><span class="pre">getCurrentValue()</span></tt>, it implements <tt class="docutils literal"><span class="pre">nextRecord()</span></tt> and <tt class="docutils literal"><span class="pre">getCurrentRecord()</span></tt>.</p>
<p>Typically, you do not implement these methods from scratch but rely on the <tt class="docutils literal"><span class="pre">BatchReadable</span></tt>
implementation of the underlying Tables and Datasets. For example, if your Dataset is backed by a <tt class="docutils literal"><span class="pre">Table</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">MyDataset</span> <span class="kd">implements</span> <span class="n">Dataset</span><span class="o">,</span> <span class="n">RecordScannable</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">Table</span> <span class="n">table</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">VALUE_COLUMN</span> <span class="o">=</span> <span class="o">{</span> <span class="sc">&#39;c&#39;</span> <span class="o">};</span>

  <span class="c1">// ..</span>
  <span class="c1">// All other Dataset methods</span>
  <span class="c1">// ...</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Entry</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Split</span><span class="o">&gt;</span> <span class="nf">getSplits</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="na">getSplits</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">RecordScanner</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="nf">createSplitRecordScanner</span><span class="o">(</span><span class="n">Split</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">SplitReader</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="n">Row</span><span class="o">&gt;</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">createSplitReader</span><span class="o">(</span><span class="n">split</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">RecordScanner</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">Split</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">split</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">nextRecord</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="na">nextKeyValue</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">Entry</span> <span class="nf">getCurrentRecord</span><span class="o">()</span>  <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Entry</span><span class="o">(</span>
          <span class="n">Bytes</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">getCurrentKey</span><span class="o">()),</span>
          <span class="n">reader</span><span class="o">.</span><span class="na">getCurrentValue</span><span class="o">().</span><span class="na">getInt</span><span class="o">(</span><span class="n">VALUE_COLUMN</span><span class="o">));</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>

    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>While this is straightforward, it is even easier if your Dataset already implements <tt class="docutils literal"><span class="pre">BatchReadable</span></tt>.
In that case, you can reuse its implementation of <tt class="docutils literal"><span class="pre">getSplits()</span></tt> and implement the split record scanner
with a helper method
(<tt class="docutils literal"><span class="pre">Scannables.splitRecordScanner</span></tt>) already defined by CDAP. It takes a split reader and a <tt class="docutils literal"><span class="pre">RecordMaker</span></tt>
that transforms a key and value, as produced by the <tt class="docutils literal"><span class="pre">BatchReadable</span></tt>&#8216;s split reader,
into a record:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">RecordScanner</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="nf">createSplitRecordScanner</span><span class="o">(</span><span class="n">Split</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">Scannables</span><span class="o">.</span><span class="na">splitRecordScanner</span><span class="o">(</span>
    <span class="n">table</span><span class="o">.</span><span class="na">createSplitReader</span><span class="o">(</span><span class="n">split</span><span class="o">),</span>
    <span class="k">new</span> <span class="n">Scannables</span><span class="o">.</span><span class="na">RecordMaker</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="n">Row</span><span class="o">,</span> <span class="n">Entry</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="n">Entry</span> <span class="nf">makeRecord</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">key</span><span class="o">,</span> <span class="n">Row</span> <span class="n">row</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Entry</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">row</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">VALUE_COLUMN</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note there is an even simpler helper (<tt class="docutils literal"><span class="pre">Scannables.valueRecordScanner</span></tt>) that derives a split
record scanner from a split reader. For each key and value returned by the split reader it ignores the key
and returns the value. For example,
if your dataset implements <tt class="docutils literal"><span class="pre">BatchReadable&lt;String,</span> <span class="pre">Employee&gt;</span></tt>, then you can implement <tt class="docutils literal"><span class="pre">RecordScannable&lt;Employee&gt;</span></tt> by
defining:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">RecordScanner</span><span class="o">&lt;</span><span class="n">Employee</span><span class="o">&gt;</span> <span class="nf">createSplitRecordScanner</span><span class="o">(</span><span class="n">Split</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">Scannables</span><span class="o">.</span><span class="na">valueRecordScanner</span><span class="o">(</span><span class="n">table</span><span class="o">.</span><span class="na">createSplitReader</span><span class="o">(</span><span class="n">split</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
<p>An example demonstrating an implementation of <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> is included in the Cask Data Application Platform SDK in the
directory <tt class="docutils literal"><span class="pre">examples/Purchase</span></tt>, namely the <tt class="docutils literal"><span class="pre">PurchaseHistoryStore</span></tt>.</p>
</div>
<div class="section" id="writing-to-datasets-with-sql">
<h2>Writing to Datasets with SQL<a class="headerlink" href="#writing-to-datasets-with-sql" title="Permalink to this headline">¶</a></h2>
<p>Data can be inserted into Datasets using SQL. For example, you can write to a Dataset named
<tt class="docutils literal"><span class="pre">ProductCatalog</span></tt> with this SQL query:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">TABLE</span> <span class="n">cdap_user_productcatalog</span> <span class="n">SELECT</span> <span class="o">...</span>
</pre></div>
</div>
<p>In order for a Dataset to enable record insertion from SQL query, it simply has to expose a way to write records
into itself.</p>
<p>For CDAP Datasets, this is done by implementing the <tt class="docutils literal"><span class="pre">RecordWritable</span></tt> interface.
The system Dataset KeyValueTable already implements this and can be used to insert records from SQL queries.</p>
<p>Let&#8217;s take a closer look at the <tt class="docutils literal"><span class="pre">RecordWritable</span></tt> interface.</p>
<div class="section" id="id2">
<h3>Defining the Record Schema<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Just like in the <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> interface, the record schema is given by returning the Java type of each record,
using the method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">();</span>
</pre></div>
</div>
<p><a class="reference internal" href="#sql-limitations"><em>The same rules</em></a> that apply to the type of the <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> interface apply
to the type of the <tt class="docutils literal"><span class="pre">RecordWritable</span></tt> interface. In fact, if a Dataset implements both <tt class="docutils literal"><span class="pre">RecordScannable</span></tt> and
<tt class="docutils literal"><span class="pre">RecordWritable</span></tt> interfaces, they will have to use identical record types.</p>
</div>
<div class="section" id="writing-records">
<h3>Writing Records<a class="headerlink" href="#writing-records" title="Permalink to this headline">¶</a></h3>
<p>To enable inserting SQL query results, a Dataset needs to provide a means of writing a record into itself.
This is similar to how the <tt class="docutils literal"><span class="pre">BatchWritable</span></tt> interface makes Datasets writable from MapReduce programs by providing
a way to write pairs of key and value. You need to implement the <tt class="docutils literal"><span class="pre">RecordWritable</span></tt> method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">RECORD</span> <span class="n">record</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
</pre></div>
</div>
<p>Continuing the <em>MyDataset</em> <a class="reference internal" href="#sql-scanning-records"><em>example used above</em></a>, which showed an implementation of
<tt class="docutils literal"><span class="pre">RecordScannable</span></tt>, this example an implementation of a <tt class="docutils literal"><span class="pre">RecordWritable</span></tt> Dataset that is backed by a <tt class="docutils literal"><span class="pre">Table</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">MyDataset</span> <span class="kd">implements</span> <span class="n">Dataset</span><span class="o">,</span> <span class="o">...,</span> <span class="n">RecordWritable</span><span class="o">&lt;</span><span class="n">Entry</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">Table</span> <span class="n">table</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">VALUE_COLUMN</span> <span class="o">=</span> <span class="o">{</span> <span class="sc">&#39;c&#39;</span> <span class="o">};</span>

  <span class="c1">// ..</span>
  <span class="c1">// All other Dataset methods</span>
  <span class="c1">// ...</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Type</span> <span class="nf">getRecordType</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Entry</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Entry</span> <span class="n">record</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span> <span class="n">VALUE_COLUMN</span><span class="o">,</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note that a Dataset can implement either <tt class="docutils literal"><span class="pre">RecordScannable</span></tt>, <tt class="docutils literal"><span class="pre">RecordWritable</span></tt>, or both.</p>
</div>
</div>
<div class="section" id="formulating-queries">
<h2>Formulating Queries<a class="headerlink" href="#formulating-queries" title="Permalink to this headline">¶</a></h2>
<p>When creating your queries, keep these limitations in mind:</p>
<ul class="simple">
<li>The query syntax of CDAP is a subset of the variant of SQL that was first defined by Apache Hive.</li>
<li>The SQL commands <tt class="docutils literal"><span class="pre">UPDATE</span></tt> and <tt class="docutils literal"><span class="pre">DELETE</span></tt> are not allowed on CDAP Datasets.</li>
<li>When addressing your datasets in queries, you need to prefix the data set name with the CDAP
namespace <tt class="docutils literal"><span class="pre">cdap_user_</span></tt>. For example, if your Dataset is named <tt class="docutils literal"><span class="pre">ProductCatalog</span></tt>, then the corresponding table
name is <tt class="docutils literal"><span class="pre">cdap_user_productcatalog</span></tt>. Note that the table name is lower-case.</li>
</ul>
<p>For more examples of queries, please refer to the <a class="reference external" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-InsertingdataintoHiveTablesfromqueries">Hive language manual</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html"
        rel="nofollow">CDAP Documentation v2.7.1</a></h3>
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../index.html"
            rel="nofollow">Introduction</a></li>
            
      <li><div class=""></div><b><a href="../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></b></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
            
      <li><div class="new-icon"></div><a href="../table-of-contents/../../integrations/index.html"
            rel="nofollow">Integrations</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/faq.html"
            rel="nofollow">FAQ</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../search.html"
            rel="nofollow">Search</a></li>
    </ul>
   </div><!--
  Copyright © 2014-2015 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->


<h3 class="pagenavtitle"><a href="../table-of-contents.html">Developers’ Manual: Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html"> Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html"> Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html"> Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../building-blocks/index.html"> Building Blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html"> Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html"> Testing and Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ingesting-tools/index.html"> Ingesting Data</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html"> Data Exploration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="streams.html"> Stream Exploration</a></li>
<li class="toctree-l2"><a class="reference internal" href="filesets.html"> Fileset Exploration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href=""> Custom Dataset Exploration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defining-the-record-schema">Defining the Record Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameterized-types">Parameterized Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complex-types">Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scanning-records">Scanning Records</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-to-datasets-with-sql">Writing to Datasets with SQL</a></li>
<li class="toctree-l3"><a class="reference internal" href="#formulating-queries">Formulating Queries</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html"> Advanced Topics</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="filesets.html"
                        title="Previous Chapter">Fileset Exploration</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="../advanced/index.html"
                        title="Next Chapter">Advanced Topics</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/2.7.1/cdap-docs-2.7.1-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Fileset Exploration" href="filesets.html" />Fileset Exploration</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        Copyright &copy; 2014-2015 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Advanced Topics" href="../advanced/index.html" />Advanced Topics</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>