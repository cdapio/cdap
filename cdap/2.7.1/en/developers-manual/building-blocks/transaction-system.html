<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2014-2015 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55081520-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Transaction System &mdash; Cask Data Application Platform 2.7.1 Documentation</title>
    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.7.1 Documentation" href="../index.html" />
    <link rel="up" title="Building Blocks" href="index.html" />
    <link rel="next" title="Security" href="../security/index.html" />
    <link rel="prev" title="Services" href="services.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../security/index.html" title="Security"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="services.html" title="Services"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('2.7.1');</script>
       
        <li><a href="../table-of-contents.html">CDAP Developers’ Manual</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Building Blocks</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="transaction-system">
<span id="id1"></span><h1>Transaction System<a class="headerlink" href="#transaction-system" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-need-for-transactions">
<h2>The Need for Transactions<a class="headerlink" href="#the-need-for-transactions" title="Permalink to this headline">¶</a></h2>
<p>A Flowlet processes the data objects received on its inputs one at a time. While processing
a single input object, all operations, including the removal of the data from the input,
and emission of data to the outputs, are executed in a <strong>transaction</strong>. This provides us
with ACID—atomicity, consistency, isolation, and durability properties:</p>
<ul class="simple">
<li>The process method runs under read isolation to ensure that it does not see dirty writes
(uncommitted writes from concurrent processing) in any of its reads.
It does see, however, its own writes.</li>
<li>A failed attempt to process an input object leaves the data in a consistent state;
it does not leave partial writes behind.</li>
<li>All writes and emission of data are committed atomically;
either all of them or none of them are persisted.</li>
<li>After processing completes successfully, all its writes are persisted in a durable way.</li>
</ul>
<p>In case of failure, the state of the data is unchanged and processing of the input
object can be reattempted. This ensures &#8220;exactly-once&#8221; processing of each object.</p>
</div>
<div class="section" id="occ-optimistic-concurrency-control">
<h2>OCC: Optimistic Concurrency Control<a class="headerlink" href="#occ-optimistic-concurrency-control" title="Permalink to this headline">¶</a></h2>
<p>The Cask Data Application Platform uses <a class="reference external" href="http://tephra.io">Cask&#8217;s Tephra,</a> which uses
<em>Optimistic Concurrency Control</em> (OCC) to implement transactions. Unlike most relational
databases that use locks to prevent conflicting operations between transactions, under OCC
we allow these conflicting writes to happen. When the transaction is committed, we can
detect whether it has any conflicts: namely, if during the lifetime of the transaction,
another transaction committed a write for one of the same keys that the transaction has
written. In that case, the transaction is aborted and all of its writes are rolled back.</p>
<p>In other words: If two overlapping transactions modify the same row, then the transaction
that commits first will succeed, but the transaction that commits last is rolled back due
to a write conflict.</p>
<p>Optimistic Concurrency Control is lockless and therefore avoids problems such as idle
processes waiting for locks, or even worse, deadlocks. However, it comes at the cost of
rollback in case of write conflicts. We can only achieve high throughput with OCC if the
number of conflicts is small. It is therefore good practice to reduce the probability of
conflicts wherever possible.</p>
<p>Here are some rules to follow for Flows, Flowlets, Services, and Procedures:</p>
<ul class="simple">
<li>Keep transactions short. The Cask Data Application Platform attempts to delay the beginning of each
transaction as long as possible. For instance, if your Flowlet only performs write
operations, but no read operations, then all writes are deferred until the process
method returns. They are then performed and transacted, together with the
removal of the processed object from the input, in a single batch execution.
This minimizes the duration of the transaction.</li>
<li>However, if your Flowlet performs a read, then the transaction must
begin at the time of the read. If your Flowlet performs long-running
computations after that read, then the transaction runs longer, too,
and the risk of conflicts increases. It is therefore good practice
to perform reads as late in the process method as possible.</li>
<li>There are two ways to perform an increment: As a write operation that
returns nothing, or as a read-write operation that returns the incremented
value. If you perform the read-write operation, then that forces the
transaction to begin, and the chance of conflict increases. Unless you
depend on that return value, you should always perform an increment
only as a write operation.</li>
<li>Use hash-based partitioning for the inputs of highly concurrent Flowlets
that perform writes. This helps reduce concurrent writes to the same
key from different instances of the Flowlet.</li>
</ul>
<p>Keeping these guidelines in mind will help you write more efficient and faster-performing
code.</p>
</div>
<div class="section" id="levels-of-conflict-detection">
<span id="transaction-system-conflict-detection"></span><h2>Levels of Conflict Detection<a class="headerlink" href="#levels-of-conflict-detection" title="Permalink to this headline">¶</a></h2>
<p>Transactions providing ACID (atomicity, consistency, isolation, and durability) guarantees
are useful in several applications where data accuracy is critical—examples include billing
applications and computing click-through rates.</p>
<p>However, transaction are not for free: the transaction system must track all the writes
made by all transactions, and it must check transactions for conflicts before committing them.
If conflicts are frequent, they will impact performance because the failed transactions
have to be rolled back and reattempted.</p>
<p>In some scenarios, you may want to fine-tune the manner in which a dataset participates in
transactions:</p>
<ul class="simple">
<li>Some applications—such as trending—might not need transactions for all writes, because
small inaccuracies have little effect on trends with great momentum. Applications that
do not strictly require accuracy can trade it for increased throughput by disabling
transactions for some datasets.</li>
<li>Some applications perform concurrent updates to the same row of a table, but typically
those updates do not strictly conflict with each other because they are on different
columns of the row. In this case it can make sense to increase the precision of conflict
detection by tracking changes at the column level instead of the row level.</li>
</ul>
<p>Both of these can be achieved by specifying a conflict detection level when the table is
created. For example, in your application&#8217;s <tt class="docutils literal"><span class="pre">configure()</span></tt> method:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">Tables</span><span class="o">.</span><span class="na">createTable</span><span class="o">(</span><span class="n">getConfigurer</span><span class="o">(),</span> <span class="s">&quot;myTable&quot;</span><span class="o">,</span> <span class="n">ConflictDetection</span><span class="o">.</span><span class="na">COLUMN</span><span class="o">);</span>
</pre></div>
</div>
<p>You have these options:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">ConflictDetection.NONE</span></tt> to disable transactions for the table. None of the writes
performed on this table will participate in conflict detection. However, all writes
will still be rolled back in case of a transaction failure (the transaction may fail
for other reasons than a conflict on this table).</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">ConflictDetection.ROW</span></tt> to track writes at the row level. This means that two
concurrent transactions will cause a conflict if they write to the same row of the table,
even if the writes are for different columns. This is the default.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">ConflictDetection.COLUMN</span></tt> to increase the precision of the conflict detection to
the column level: Two concurrent transactions can write to the same row without conflict,
as long as they write to disjoint sets of columns. This will increase the overhead for
each transaction, because the transaction system must track writes with greater detail.
But it can also greatly reduce the number of transaction conflicts, leading to improved
overall application throughput.</p>
<p>See the <a class="reference external" href="../source/../../examples-manual/examples/user-profiles.html#examples-user-profiles" title="(in Cask Data Application Platform v2.7.1)"><em class="xref std std-ref">UserProfile example</em></a>
for a sample use case.</p>
</li>
</ul>
</div>
<div class="section" id="transactions-in-mapreduce">
<h2>Transactions in MapReduce<a class="headerlink" href="#transactions-in-mapreduce" title="Permalink to this headline">¶</a></h2>
<p>When you run a MapReduce that interacts with Datasets, the system creates a
long-running transaction. Similar to the transaction of a Flowlet or a Procedure, here are
some rules to follow:</p>
<ul class="simple">
<li>Reads can only see the writes of other transactions that were committed
at the time the long-running transaction was started.</li>
<li>All writes of the long-running transaction are committed atomically,
and only become visible to others after they are committed.</li>
<li>The long-running transaction can read its own writes.</li>
</ul>
<p>However, there is a key difference: long-running transactions do not participate in
conflict detection. If another transaction overlaps with the long-running transaction and
writes to the same row, it will not cause a conflict but simply overwrite it.</p>
<p>It is not efficient to fail the long-running job based on a single conflict. Because of
this, it is not recommended to write to the same Dataset from both real-time and MapReduce
programs. It is better to use different Datasets, or at least ensure that the real-time
processing writes to a disjoint set of columns.</p>
<p>It&#8217;s important to note that the MapReduce framework will reattempt a task (Mapper or
Reducer) if it fails. If the task is writing to a Dataset, the reattempt of the task will
most likely repeat the writes that were already performed in the failed attempt. Therefore
it is highly advisable that all writes performed by MapReduce programs be idempotent.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html"
        rel="nofollow">CDAP Documentation v2.7.1</a></h3>
    <ul class="this-page-menu">
      <li><div class=""></div><a href="../table-of-contents/../../index.html"
            rel="nofollow">Introduction</a></li>
            
      <li><div class=""></div><b><a href="../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></b></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
            
      <li><div class="new-icon"></div><a href="../table-of-contents/../../integrations/index.html"
            rel="nofollow">Integrations</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../reference-manual/faq.html"
            rel="nofollow">FAQ</a></li>
            
      <li><div class=""></div><a href="../table-of-contents/../../search.html"
            rel="nofollow">Search</a></li>
    </ul>
   </div><!--
  Copyright © 2014-2015 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->


<h3 class="pagenavtitle"><a href="../table-of-contents.html">Developers’ Manual: Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html"> Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html"> Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html"> Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html"> Building Blocks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core.html"> Core Virtualizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="applications.html"> Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="streams.html"> Streams</a></li>
<li class="toctree-l2"><a class="reference internal" href="datasets/index.html"> Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="flows-flowlets/index.html"> Flows and Flowlets</a></li>
<li class="toctree-l2"><a class="reference internal" href="mapreduce-programs.html"> MapReduce Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html"> Workflows</a></li>
<li class="toctree-l2"><a class="reference internal" href="schedules.html"> Schedules</a></li>
<li class="toctree-l2"><a class="reference internal" href="spark-programs.html"> Spark Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="procedures.html"> Procedures</a></li>
<li class="toctree-l2"><a class="reference internal" href="services.html"> Services</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href=""> Transaction System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-need-for-transactions">The Need for Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#occ-optimistic-concurrency-control">OCC: Optimistic Concurrency Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="#levels-of-conflict-detection">Levels of Conflict Detection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transactions-in-mapreduce">Transactions in MapReduce</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html"> Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing/index.html"> Testing and Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ingesting-tools/index.html"> Ingesting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-exploration/index.html"> Data Exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html"> Advanced Topics</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="services.html"
                        title="Previous Chapter">Services</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="../security/index.html"
                        title="Next Chapter">Security</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/2.7.1/cdap-docs-2.7.1-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Services" href="services.html" />Services</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        Copyright &copy; 2014-2015 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Security" href="../security/index.html" />Security</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>