<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="Cask Data, Inc." name="author" />
<meta content="Copyright © 2014 Cask Data, Inc." name="copyright" />
<script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-55077523-3']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Ingesting Data into CDAP using Apache Flume &mdash; Cask Data Application Platform 2.6.1 Documentation</title>
    
    <link rel="stylesheet" href="../_static/cdap.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    



    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Cask Data Application Platform 2.6.1 Documentation" href="../index.html" />
    <link rel="up" title="How-To Guides" href="index.html" />
    <link rel="next" title="Batch Data Processing With CDAP" href="cdap-mapreduce-guide.html" />
    <link rel="prev" title="Realtime Data Processing with a Flow" href="cdap-flow-guide.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="cdap-mapreduce-guide.html" title="Batch Data Processing With CDAP"
             accesskey="N">Next</a> |</li>
        <li class="right" >
          <a href="cdap-flow-guide.html" title="Realtime Data Processing with a Flow"
             accesskey="P">Previous</a> |</li>
        
        <script type="text/javascript" src="../_static/version-menu.js"></script>
        <script src="http://docs.cask.co/cdap/json-versions.js"/></script>
        <script>window.setVersion('2.6.1');</script>
       
        <li><a href="../table-of-contents.html">CDAP Examples, Guides, and Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">How-To Guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ingesting-data-into-cdap-using-apache-flume">
<span id="cdap-flume-guide"></span><h1>Ingesting Data into CDAP using Apache Flume<a class="headerlink" href="#ingesting-data-into-cdap-using-apache-flume" title="Permalink to this headline">¶</a></h1>
<blockquote class="pull-quote">
<div><strong>Source Code Repository:</strong> Source code (and other resources) for this guide are available at the
<a class="reference external" href="https://github.com/cdap-guides/cdap-flume-guide">CDAP Guides GitHub repository</a>.</div></blockquote>
<p>Ingesting realtime log data into Hadoop for analysis is a common use
case which can be solved with <a class="reference external" href="http://flume.apache.org/">Apache
Flume.</a> In this guide, you will learn how
to ingest data into CDAP with Apache Flume and process it in realtime.</p>
<div class="section" id="what-you-will-build">
<h2>What You Will Build<a class="headerlink" href="#what-you-will-build" title="Permalink to this headline">¶</a></h2>
<p>You will build a <a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/applications.html">CDAP
application</a>
that uses web logs aggregated by Flume to find page view counts. You
will:</p>
<ul class="simple">
<li>Configure Flume to ingest data into a <a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/streams.html">CDAP
Stream;</a></li>
<li>Build a realtime
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/flows-flowlets/flows.html">Flow</a>
to process the ingested web logs; and</li>
<li>Build a
<a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/building-blocks/services.html">Service</a>
to serve the analysis results via HTTP.</li>
</ul>
</div>
<div class="section" id="what-you-will-need">
<h2>What You Will Need<a class="headerlink" href="#what-you-will-need" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 6 or JDK
7</a></li>
<li><a class="reference external" href="http://maven.apache.org/">Apache Maven 3.0+</a></li>
<li><a class="reference external" href="http://docs.cdap.io/cdap/current/en/developers-manual/getting-started/standalone/index.html">CDAP
SDK</a></li>
<li><a class="reference external" href="http://flume.apache.org/download.html">Apache Flume</a></li>
</ul>
</div>
<div class="section" id="lets-build-it">
<h2>Let’s Build It!<a class="headerlink" href="#lets-build-it" title="Permalink to this headline">¶</a></h2>
<p>The following sections will guide you through configuring and running
Flume, and implementing an application from scratch. If you want to
deploy and run the application right away, you can clone the sources
from this GitHub repository. In that case, feel free to skip the
following two sections and jump directly to the <a class="reference external" href="#build-and-run-application">Build and Run
Application</a> section.</p>
</div>
<div class="section" id="application-design">
<h2>Application Design<a class="headerlink" href="#application-design" title="Permalink to this headline">¶</a></h2>
<p>Web logs are aggregated using Flume which pushes the data to a
<tt class="docutils literal"><span class="pre">webLogs</span></tt> stream using a special <tt class="docutils literal"><span class="pre">StreamSink</span></tt> from the
<a class="reference external" href="https://github.com/caskdata/cdap-ingest/cdap-flume">cdap-ingest</a>
library. Then, logs are processed in realtime with a Flow that consumes
data from the <tt class="docutils literal"><span class="pre">webLogs</span></tt> Stream and persists the computation results in
a <tt class="docutils literal"><span class="pre">pageViews</span></tt> Dataset. The <tt class="docutils literal"><span class="pre">WebLogAnalyticsService</span></tt> makes the
computation results stored in the <tt class="docutils literal"><span class="pre">pageViews</span></tt> Dataset accessible via
HTTP.</p>
<div class="figure">
<img alt="" src="../_images/app-design2.png" />
</div>
<p>First, we will build the app, then deploy the app and start it. Once it
is ready to accept and process the data, we will configure Flume to push
data into the stream in realtime.</p>
</div>
<div class="section" id="application-implementation">
<h2>Application Implementation<a class="headerlink" href="#application-implementation" title="Permalink to this headline">¶</a></h2>
<p>The recommended way to build a CDAP application from scratch is to use a
maven project. Use this directory structure:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">./pom.xml</span>
<span class="go">./src/main/java/co/cask/cdap/guides/PageViewCounterFlowlet.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/WebLogAnalyticsApplication.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/WebLogAnalyticsFlow.java</span>
<span class="go">./src/main/java/co/cask/cdap/guides/WebLogAnalyticsHandler.java</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">WebLogAnalyticsApplication</span></tt> declares that the application has a
Stream, a Flow, a Service and uses a Dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebLogAnalyticsApplication</span> <span class="kd">extends</span> <span class="n">AbstractApplication</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">setName</span><span class="o">(</span><span class="s">&quot;WebLogAnalyticsApp&quot;</span><span class="o">);</span>
    <span class="n">addStream</span><span class="o">(</span><span class="k">new</span> <span class="n">Stream</span><span class="o">(</span><span class="s">&quot;webLogs&quot;</span><span class="o">));</span>
    <span class="n">createDataset</span><span class="o">(</span><span class="s">&quot;pageViewTable&quot;</span><span class="o">,</span> <span class="n">KeyValueTable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">addFlow</span><span class="o">(</span><span class="k">new</span> <span class="n">WebLogAnalyticsFlow</span><span class="o">());</span>
    <span class="n">addService</span><span class="o">(</span><span class="s">&quot;WebLogAnalyticsService&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">WebLogAnalyticsHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">WebLogAnalyticsFlow</span></tt> makes use of the <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebLogAnalyticsFlow</span> <span class="kd">implements</span> <span class="n">Flow</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">FlowSpecification</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">FlowSpecification</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">with</span><span class="o">().</span>
      <span class="n">setName</span><span class="o">(</span><span class="s">&quot;WebLogAnalyticsFlow&quot;</span><span class="o">).</span>
      <span class="n">setDescription</span><span class="o">(</span><span class="s">&quot;A flow that collects and performs web log analysis&quot;</span><span class="o">).</span>
      <span class="n">withFlowlets</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;pageViewCounter&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">PageViewCounterFlowlet</span><span class="o">()).</span>
      <span class="n">connect</span><span class="o">().</span><span class="na">fromStream</span><span class="o">(</span><span class="s">&quot;webLogs&quot;</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;pageViewCounter&quot;</span><span class="o">).</span>
      <span class="n">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt> receives the log events from the
<tt class="docutils literal"><span class="pre">webLogs</span></tt> Stream. It parses the log event and extracts the requested
page URL from the log event. Then it increments respective counter in
the <tt class="docutils literal"><span class="pre">pageViewTable</span></tt> Dataset:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PageViewCounterFlowlet</span> <span class="kd">extends</span> <span class="n">AbstractFlowlet</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">PageViewCounterFlowlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">ACCESS_LOG_PATTERN</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span>
    <span class="c1">//   IP       id    user      date          request     code     size    referrer    user agent</span>
    <span class="s">&quot;^([\\d.]+) (\\S+) (\\S+) \\[([^\\]]+)\\] \&quot;([^\&quot;]+)\&quot; (\\d{3}) (\\d+) \&quot;([^\&quot;]+)\&quot; \&quot;([^\&quot;]+)\&quot;&quot;</span><span class="o">);</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">REQUEST_PAGE_PATTERN</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;(\\S+)\\s(\\S+).*&quot;</span><span class="o">);</span>

  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;pageViewTable&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">KeyValueTable</span> <span class="n">pageViewTable</span><span class="o">;</span>

  <span class="nd">@ProcessInput</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">StreamEvent</span> <span class="n">log</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">event</span> <span class="o">=</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">getBody</span><span class="o">()).</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">Matcher</span> <span class="n">logMatcher</span> <span class="o">=</span> <span class="n">ACCESS_LOG_PATTERN</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">logMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">()</span> <span class="o">||</span> <span class="n">logMatcher</span><span class="o">.</span><span class="na">groupCount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Invalid event received {}&quot;</span><span class="o">,</span> <span class="n">log</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">request</span> <span class="o">=</span> <span class="n">logMatcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">Matcher</span> <span class="n">requestMatcher</span> <span class="o">=</span> <span class="n">REQUEST_PAGE_PATTERN</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">requestMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">()</span> <span class="o">||</span> <span class="n">requestMatcher</span><span class="o">.</span><span class="na">groupCount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Invalid event received {}&quot;</span><span class="o">,</span> <span class="n">log</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">requestMatcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="n">pageViewTable</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="n">Bytes</span><span class="o">.</span><span class="na">toBytes</span><span class="o">(</span><span class="n">uri</span><span class="o">),</span> <span class="mi">1L</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>For example, given the following event:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">192.168.139.1 - - [14/Jan/2014:08:40:43 -0400] &quot;GET https://accounts.example.org/signup HTTP/1.0&quot; 200 809 &quot;http://www.example.org&quot; &quot;example v4.10.5 (www.example.org)&quot;</span>
</pre></div>
</div>
<p>the extracted requested page URL is
<tt class="docutils literal"><span class="pre">https://accounts.example.org/signup</span></tt>. This will be used as a counter
key in the <tt class="docutils literal"><span class="pre">pageViewTable</span></tt> Dataset.</p>
<p><tt class="docutils literal"><span class="pre">WebLogAnalyticsHandler</span></tt> returns a map of the webpage and its
page-views counts for an HTTP GET request at <tt class="docutils literal"><span class="pre">/views</span></tt>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebLogAnalyticsHandler</span> <span class="kd">extends</span> <span class="n">AbstractHttpServiceHandler</span> <span class="o">{</span>
  <span class="nd">@UseDataSet</span><span class="o">(</span><span class="s">&quot;pageViewTable&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">KeyValueTable</span> <span class="n">pageViewTable</span><span class="o">;</span>

  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;views&quot;</span><span class="o">)</span>
  <span class="nd">@GET</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getViews</span><span class="o">(</span><span class="n">HttpServiceRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServiceResponder</span> <span class="n">responder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">KeyValue</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span> <span class="n">pageViewScan</span> <span class="o">=</span> <span class="n">pageViewTable</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">pageViews</span> <span class="o">=</span> <span class="n">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">pageViewScan</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">KeyValue</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">pageViewScan</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
     <span class="n">pageViews</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span> <span class="n">Bytes</span><span class="o">.</span><span class="na">toLong</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="n">responder</span><span class="o">.</span><span class="na">sendString</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">pageViews</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">Charsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="build-and-run-application">
<h2>Build and Run Application<a class="headerlink" href="#build-and-run-application" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">WebLogAnalyticsApp</span></tt> can be built and packaged using the Apache
Maven command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">mvn clean package</span>
</pre></div>
</div>
<p>Note that the remaining commands assume that the <tt class="docutils literal"><span class="pre">cdap-cli.sh</span></tt> script
is available on your PATH. If this is not the case, please add it:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">export PATH=$PATH:&lt;CDAP home&gt;/bin</span>
</pre></div>
</div>
<p>If you haven&#8217;t already started a standalone CDAP installation, start it
with the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cdap.sh start</span>
</pre></div>
</div>
<p>We can then deploy the application to a standalone CDAP installation and
start the flow and service:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cdap-cli.sh deploy app target/cdap-flume-guide-1.0.0.jar</span>
<span class="go">cdap-cli.sh start flow WebLogAnalyticsApp.WebLogAnalyticsFlow</span>
<span class="go">cdap-cli.sh start service WebLogAnalyticsApp.WebLogAnalyticsService</span>
</pre></div>
</div>
<p>Once the flow has started, it is ready to receive the web logs from the
stream. Now, let’s configure and start Flume to push web logs into the
stream.</p>
</div>
<div class="section" id="ingest-data-with-flume">
<h2>Ingest Data with Flume<a class="headerlink" href="#ingest-data-with-flume" title="Permalink to this headline">¶</a></h2>
<p>In the provided sources for this guide, you can find an Apache web
server’s <tt class="docutils literal"><span class="pre">access.log</span></tt> file that we will use as a source of data. If
you have access to live Apache web server’s access logs, you can use
them instead.</p>
<p>In order to configure Apache Flume to push web logs to a CDAP Stream,
you need to create a simple Flume flow which includes:</p>
<ul class="simple">
<li>Flume source that tail access logs;</li>
<li>In-memory channel; and</li>
<li>Flume sink that sends log lines into the CDAP Stream.</li>
</ul>
<p>In this example, we will configure the source to tail <tt class="docutils literal"><span class="pre">access.log</span></tt> and
<tt class="docutils literal"><span class="pre">sink</span></tt> to send data to the <tt class="docutils literal"><span class="pre">webLogs</span></tt> stream.</p>
</div>
<div class="section" id="download-flume">
<h2>Download Flume<a class="headerlink" href="#download-flume" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">You can download the Apache Flume distribution at <a class="reference external" href="http://flume.apache.org/download.html">Apache Flume
download.</a></p>
</li>
<li><p class="first">Once downloaded, extract the archive into <tt class="docutils literal"><span class="pre">&lt;flume-base-dir&gt;</span></tt>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">tar -xvf apache-flume-*-bin.tar.gz</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="configure-flume-flow">
<h2>Configure Flume Flow<a class="headerlink" href="#configure-flume-flow" title="Permalink to this headline">¶</a></h2>
<p>Download the CDAP Flume sink jar into your Flume installation:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cd &lt;flume-base-dir&gt;/lib</span>
<span class="go">curl --remote-name https://oss.sonatype.org/content/repositories/releases/co/cask/cdap/cdap-flume/1.0.1/cdap-flume-1.0.1.jar</span>
</pre></div>
</div>
<p>The CDAP Flume sink requires a newer version of
<a class="reference external" href="https://code.google.com/p/guava-libraries/">Guava</a> library than that
is usually shipped with Flume. You need to replace the existing Flume
Guava library with <tt class="docutils literal"><span class="pre">guava-17.0.jar</span></tt>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> these commands are executed at &lt;flume-base-dir&gt;/lib
<span class="go">rm guava-*.jar</span>
<span class="go">curl --remote-name https://repo1.maven.org/maven2/com/google/guava/guava/17.0/guava-17.0.jar</span>
</pre></div>
</div>
<p>Now, let’s configure the flow by creating the configuration file
<tt class="docutils literal"><span class="pre">weblog-analysis.conf</span></tt> at <tt class="docutils literal"><span class="pre">&lt;flume-base-dir&gt;/conf</span></tt> with these
contents:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">a1.sources = r1</span>
<span class="go">a1.channels = c1</span>
<span class="go">a1.sources.r1.type = exec</span>
<span class="go">a1.sources.r1.command = tail -F &lt;cdap-flume-ingest-guide-basedir&gt;/data/access.log</span>
<span class="go">a1.sources.r1.channels = c1</span>
<span class="go">a1.sinks = k1</span>
<span class="go">a1.sinks.k1.type = co.cask.cdap.flume.StreamSink</span>
<span class="go">a1.sinks.k1.channel = c1</span>
<span class="go">a1.sinks.k1.host  = 127.0.0.1</span>
<span class="go">a1.sinks.k1.port = 10000</span>
<span class="go">a1.sinks.k1.streamName = webLogs</span>
<span class="go">a1.channels.c1.type = memory</span>
<span class="go">a1.channels.c1.capacity = 1000</span>
<span class="go">a1.channels.c1.transactionCapacity = 100</span>
</pre></div>
</div>
<p>Change <tt class="docutils literal"><span class="pre">&lt;cdap-flume-ingest-guide-basedir&gt;</span></tt> in the configuration file
to point to the <tt class="docutils literal"><span class="pre">&lt;cdap-flume-ingest-guide&gt;</span></tt> directory. Alternatively,
you can point it to <tt class="docutils literal"><span class="pre">/tmp/access.log</span></tt>, and create <tt class="docutils literal"><span class="pre">/tmp/access.log</span></tt>
with these sample contents:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">192.168.99.124 - - [14/Jan/2014:06:51:04 -0400] &quot;GET https://accounts.example.org/signup HTTP/1.1&quot; 200 392 &quot;http://www.example.org&quot; &quot;Mozilla/5.0 (compatible; YandexBot/3.0; +http://www.example.org/bots)&quot;</span>
<span class="go">192.168.67.103 - - [14/Jan/2014:08:03:05 -0400] &quot;GET https://accounts.example.org/login HTTP/1.1&quot; 404 182 &quot;http://www.example.org&quot; &quot;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span>
<span class="go">192.168.67.103 - - [14/Jan/2014:08:03:05 -0400] &quot;GET https://accounts.example.org/signup HTTP/1.1&quot; 200 394 &quot;http://www.example.org&quot; &quot;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span>
<span class="go">192.168.139.1 - - [14/Jan/2014:08:40:43 -0400] &quot;GET https://accounts.example.org/login HTTP/1.0&quot; 404 208 &quot;http://www.example.org&quot; &quot;example v4.10.5 (www.example.org)&quot;</span>
<span class="go">192.168.139.1 - - [14/Jan/2014:08:40:43 -0400] &quot;GET https://accounts.example.org/signup HTTP/1.0&quot; 200 809 &quot;http://www.example.org&quot; &quot;example v4.10.5 (www.example.org)&quot;</span>
<span class="go">192.168.139.1 - - [14/Jan/2014:08:40:43 -0400] &quot;GET https://www.example.org/ HTTP/1.0&quot; 200 809 &quot;-&quot; &quot;example v4.10.5 (www.example.org)&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="run-flume-flow-with-agent">
<h2>Run Flume Flow with Agent<a class="headerlink" href="#run-flume-flow-with-agent" title="Permalink to this headline">¶</a></h2>
<p>To run a Flume flow, start an agent with the flow’s configuration:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">cd &lt;flume-base-dir&gt;</span>
<span class="go">./bin/flume-ng agent --conf conf --conf-file conf/weblog-analysis.conf --name a1 -Dflume.root.logger=INFO,console</span>
</pre></div>
</div>
<p>Once the agent has started, it begins to push data to the CDAP Stream.
The CDAP application, started earlier, processes the log events as soon
as data is received. Then you can query the computed page views
statistics.</p>
</div>
<div class="section" id="query-results">
<h2>Query Results<a class="headerlink" href="#query-results" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">WebLogAnalyticsService</span></tt> exposes an HTTP endpoint for you to query the
results of processing:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">curl -v -X GET http://localhost:10000/v2/apps/WebLogAnalyticsApp/services/WebLogAnalyticsService/methods/views</span>
</pre></div>
</div>
<p>Example output:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">{&quot;https://www.example.org/&quot;:1,&quot;https://accounts.example.org/signup&quot;:4,&quot;/contact-sales&quot;:2,&quot;https://accounts.example.org/login&quot;:3}</span>
</pre></div>
</div>
</div>
<div class="section" id="related-topics">
<h2>Related Topics<a class="headerlink" href="#related-topics" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.cask.co/tutorial/current/en/tutorial2.html">Wise: Web
Analytics</a>
tutorial, part of CDAP</li>
</ul>
</div>
<div class="section" id="extend-this-example">
<h2>Extend This Example<a class="headerlink" href="#extend-this-example" title="Permalink to this headline">¶</a></h2>
<p>To make this application more useful, you can extend it:</p>
<ul class="simple">
<li>Find the top visited pages by maintaining the top pages in a Dataset
and updating them from the <tt class="docutils literal"><span class="pre">PageViewCounterFlowlet</span></tt>; and</li>
<li>Calculate the bounce ratio of web pages, with batch processing.</li>
</ul>
</div>
<div class="section" id="share-and-discuss">
<h2>Share and Discuss!<a class="headerlink" href="#share-and-discuss" title="Permalink to this headline">¶</a></h2>
<p>Have a question? Discuss at the <a class="reference external" href="https://groups.google.com/forum/#!forum/cdap-user">CDAP User Mailing
List.</a></p>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h2>
<p>Copyright © 2014 Cask Data, Inc.</p>
<p>Licensed under the Apache License, Version 2.0 (the &#8220;License&#8221;); you may
not use this file except in compliance with the License. You may obtain
a copy of the License at</p>
<p><a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#8220;AS IS&#8221; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="manuals links">
    <h3><a href="../table-of-contents/../../index.html"
        rel="nofollow">CDAP Documentation v2.6.1</a></h3>
    <ul class="this-page-menu">
      <li><a href="../table-of-contents/../../index.html"
            rel="nofollow">Introduction</a></li>
      <li><a href="../table-of-contents/../../developers-manual/index.html"
            rel="nofollow">Developers’ Manual</a></li>
      <li><a href="../table-of-contents/../../admin-manual/index.html"
            rel="nofollow">Administration Manual</a></li>
      <li><b><a href="../table-of-contents/../../examples-manual/index.html"
            rel="nofollow">Examples, Guides, and Tutorials</a></b></li>
      <li><a href="../table-of-contents/../../reference-manual/index.html"
            rel="nofollow">Reference Manual</a></li>
      <li><a href="../table-of-contents/../../reference-manual/release-notes.html"
            rel="nofollow">Release Notes</a></li>
      <li><a href="../table-of-contents/../../reference-manual/glossary.html"
            rel="nofollow">Glossary</a></li>
      <li><a href="../table-of-contents/../../reference-manual/faq.html"
            rel="nofollow">FAQ</a></li>
      <li><a href="../table-of-contents/../../search.html"
            rel="nofollow">Search</a></li>
    </ul>
   </div><!--
  Copyright © 2014-2015 Cask Data, Inc.

  Licensed under the Apache License, Version 2.0 (the "License"); you may not
  use this file except in compliance with the License. You may obtain a copy of
  the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  License for the specific language governing permissions and limitations under
  the License.
-->


<h3 class="pagenavtitle"><a href="../table-of-contents.html">Examples, Guides, and Tutorials:<br> Table&nbsp;of&nbsp;Contents</a></h3>
<nav class="pagenav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-To Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cdap-flow-guide.html">Realtime Data Processing with a Flow</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Ingesting Data into CDAP using Apache Flume</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-build">What You Will Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-you-will-need">What You Will Need</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lets-build-it">Let’s Build It!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#application-design">Application Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#application-implementation">Application Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-and-run-application">Build and Run Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ingest-data-with-flume">Ingest Data with Flume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#download-flume">Download Flume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-flume-flow">Configure Flume Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-flume-flow-with-agent">Run Flume Flow with Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#query-results">Query Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#related-topics">Related Topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extend-this-example">Extend This Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#share-and-discuss">Share and Discuss!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cdap-mapreduce-guide.html">Batch Data Processing With CDAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-bi-guide.html">Analyzing CDAP Data from BI Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-timeseries-guide.html">Storing Timeseries Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-twitter-ingest-guide.html">Consuming Twitter Data in Realtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdap-spark-guide.html">Iterative Data Processing with Apache Spark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps-packs.html">Apps and Packs</a></li>
</ul>

</nav>
  <h4>Previous Topic</h4>
  <p class="topless"><a href="cdap-flow-guide.html"
                        title="Previous Chapter">Realtime Data Processing with a Flow</a></p>
  <h4>Next Topic</h4>
  <p class="topless"><a href="cdap-mapreduce-guide.html"
                        title="Next Chapter">Batch Data Processing With CDAP</a></p>
  <div role="note" aria-label="downloads links">
    <h3>Downloads</h3>
    <ul class="this-page-menu">
      <li><a href="http://docs.cask.co/cdap/2.6.1/cdap-docs-2.6.1-web.zip"
            rel="nofollow">Zip Archive of CDAP Documentation</a></li>
    </ul>
   </div>
  
<div id="searchbox" style="display: none" role="search">
  <h3>Quick Search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;margin:0px auto;}
.tg td{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg th{padding:0px 20px 0px 20px;border-width:0px;overflow:hidden;word-break:normal;font-weight:normal;}
.tg .tg-s6z2{text-align:center;}
.tg .tg-0ord{text-align:right;}
.tg a{font-weight:bold;}
</style>
<table class="tg" width= 100%>
  <tr>
    <th class="tg-031e">Previous Topic: 
    <a title="Realtime Data Processing with a Flow" href="cdap-flow-guide.html" />Realtime Data Processing with a Flow</a>&nbsp;&nbsp;
    
    </th>
    <th class="tg-s6z2">
        &copy; Copyright 2014-2015 Cask Data, Inc.
    
    </th>
    <th class="tg-0ord">&nbsp;&nbsp;Next Topic:
    <a title="Batch Data Processing With CDAP" href="cdap-mapreduce-guide.html" />Batch Data Processing With CDAP</a>
    
    </th>
  </tr>
</table>

    </div>
  </body>
</html>